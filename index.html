<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS - Student Attendance System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; }
        .header { background: #2563eb; color: white; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-title { display: flex; align-items: center; gap: 0.5rem; font-size: 1.5rem; font-weight: bold; }
        .nav-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 1rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover:not(:disabled) { background: #d97706; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-purple:hover:not(:disabled) { background: #7c3aed; }
        .btn-active { background: #1d4ed8; }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937; }
        .input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; }
        .student-row { border-bottom: 1px solid #e5e7eb; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .student-row:last-child { border-bottom: none; }
        .student-row:hover { background: #f9fafb; }
        .student-row.marked { background: #ecfdf5; }
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: #10b981; color: white; }
        .badge-orange { background: #f59e0b; color: white; }
        .badge-red { background: #ef4444; color: white; }
        .badge-purple { background: #8b5cf6; color: white; }
        .badge-gray { background: #6b7280; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; padding: 1rem; overflow-y: auto; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 0.5rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
        .checkbox-label { display: flex; align-items: center; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer; }
        .checkbox-label:hover { background: #f9fafb; }
        .checkbox-label input { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; }
        .alert { padding: 0.75rem; border-radius: 0.375rem; margin: 1rem 0; }
        .alert-warning { background: #fef3c7; border: 1px solid #fbbf24; color: #78350f; }
        .alert-success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .text-sm { font-size: 0.875rem; }
        .text-gray { color: #6b7280; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .hidden { display: none !important; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .empty-state { text-align: center; padding: 3rem; color: #9ca3af; }
        textarea { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-family: inherit; resize: vertical; }
        select { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; background: white; cursor: pointer; }
        .loading { text-align: center; padding: 2rem; }
        #current-datetime { text-align: right; white-space: nowrap; }
        @media (max-width: 768px) {
            .student-row { flex-direction: column; align-items: flex-start; }
            .btn { width: 100%; justify-content: center; }
            #current-datetime { font-size: 0.75rem; text-align: center; }
            .header-content { flex-direction: column; align-items: center; }
            .header-title { font-size: 1.25rem; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <h2>Loading Database...</h2>
        <p>Please wait...</p>
    </div>

    <div id="app" class="hidden">
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <span> üë• </span>
                    <h1>Student Attendance System</h1>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                    <div id="current-datetime" style="font-size: 0.875rem; opacity: 0.9;"></div>
                    <div class="nav-buttons">
                        <button class="btn btn-primary btn-active" onclick="showView('dashboard')">Dashboard</button>
                        <button class="btn btn-primary" onclick="showView('search')">Search</button>
                        <button class="btn btn-primary" onclick="showView('export')">Export</button>
                        <button class="btn btn-primary" onclick="showView('settings')">Settings</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- Dashboard View -->
            <div id="dashboard-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 class="card-title">Classes</h2>
                    <button class="btn btn-primary" onclick="showAddClass()">+ Add Class</button>
                </div>
                <div id="add-class-form" class="card hidden">
                    <div class="flex gap-2 flex-wrap">
                        <input type="text" id="new-class-name" class="input" placeholder="Enter class name" onkeypress="if(event.key==='Enter') addClass()" style="flex: 1; min-width: 200px;">
                        <button class="btn btn-success" onclick="addClass()">Create</button>
                        <button class="btn btn-secondary" onclick="hideAddClass()">Cancel</button>
                    </div>
                </div>
                <div id="classes-grid" class="card-grid"></div>
            </div>

            <!-- Attendance View -->
            <div id="attendance-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h2 class="card-title" id="attendance-title"></h2>
                    <button class="btn btn-secondary" onclick="backToDashboard()">Back to Dashboard</button>
                </div>
                
                <div class="card">
                    <div class="flex flex-wrap gap-3 items-center justify-between" style="margin-bottom: 1rem;">
                        <div class="flex flex-wrap gap-3 items-center">
                            <label><strong>Date:</strong></label>
                            <input type="date" id="attendance-date" class="input" style="width: auto;" onchange="onDateOrPeriodChange()">
                            <label style="margin-left: 1rem;"><strong>Period:</strong></label>
                            <select id="attendance-period" onchange="onDateOrPeriodChange()">
                                <option value="1">Period 1</option>
                                <option value="2">Period 2</option>
                                <option value="3">Period 3</option>
                                <option value="4">Period 4</option>
                                <option value="5">Period 5</option>
                                <option value="6">Period 6</option>
                                <option value="7">Period 7</option>
                                <option value="8">Period 8</option>
                            </select>
                        </div>
                        <div class="flex gap-2 flex-wrap" id="attendance-actions">
                            <button class="btn btn-success" onclick="markAllPresent()">‚úì Mark All Present</button>
                            <button class="btn btn-primary animate-pulse hidden" id="save-btn" onclick="saveAttendance()">üíæ Save Attendance</button>
                        </div>
                    </div>
                    
                    <div id="history-controls" style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                        <div id="history-button-view">
                            <button class="btn btn-purple" onclick="showHistoryControls()">üìÖ View Past Attendance</button>
                        </div>
                        <div id="history-form-view" class="hidden">
                            <div class="flex flex-wrap gap-3 items-center">
                                <button class="btn btn-secondary" onclick="hideHistoryControls()">‚Üê Back</button>
                                <label><strong>Select Date:</strong></label>
                                <input type="date" id="history-date" class="input" style="width: auto;">
                                <label><strong>Period:</strong></label>
                                <select id="history-period">
                                    <option value="1">Period 1</option>
                                    <option value="2">Period 2</option>
                                    <option value="3">Period 3</option>
                                    <option value="4">Period 4</option>
                                    <option value="5">Period 5</option>
                                    <option value="6">Period 6</option>
                                    <option value="7">Period 7</option>
                                    <option value="8">Period 8</option>
                                </select>
                                <button class="btn btn-purple" onclick="viewHistory()">View History</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="viewing-history-alert" class="alert alert-success hidden" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìÖ Viewing historical attendance records</span>
                        <button class="btn btn-secondary" onclick="exitHistoryMode()" style="padding: 0.25rem 0.75rem;">Exit History Mode</button>
                    </div>
                    
                    <div id="unsaved-alert" class="alert alert-warning hidden">
                        ‚ö†Ô∏è You have unsaved changes. Click "Save Attendance" to save your records.
                    </div>
                </div>
                
                <div class="card">
                    <div id="students-list"></div>
                </div>
            </div>

            <!-- Search View -->
            <div id="search-view" class="hidden">
                <h2 class="card-title">Search Student History</h2>
                <div class="card">
                    <div class="flex gap-2 flex-wrap">
                        <input type="text" id="search-input" class="input" placeholder="Enter student ID or name" style="flex: 1; min-width: 200px;">
                        <button class="btn btn-primary" onclick="searchStudents()">üîç Search</button>
                    </div>
                </div>
                <div id="search-results"></div>
            </div>

            <!-- Export View -->
            <div id="export-view" class="hidden">
                <h2 class="card-title">Export Reports</h2>
                
                <div class="card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">üîç≈† Attendance Report</h3>
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label><strong>Select Class:</strong></label>
                            <select id="export-class" class="input" style="margin-top: 0.5rem;">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label><strong>From Date:</strong></label>
                                <input type="date" id="export-from-date" class="input" style="margin-top: 0.5rem;">
                            </div>
                            <div>
                                <label><strong>To Date:</strong></label>
                                <input type="date" id="export-to-date" class="input" style="margin-top: 0.5rem;">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="exportAttendance()">üì• Export to Excel</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">‚ö†Ô∏è Behavior Report</h3>
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label><strong>Select Class:</strong></label>
                            <select id="export-behavior-class" class="input" style="margin-top: 0.5rem;">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="exportBehavior()">üì• Export to Excel</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="font-weight: 600; margin-bottom: 1rem;">üíæ Database Backup</h3>
                    <div class="alert alert-warning" style="margin-bottom: 1rem;">
                        <strong>‚ö†Ô∏è IMPORTANT - Data Storage Warning:</strong><br>
                        Your attendance data is stored locally in your browser. It can be lost if you:
                        <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.875rem;">
                            <li>Clear your browser cache/cookies</li>
                            <li>Use private/incognito browsing mode</li>
                            <li>Switch browsers or devices</li>
                            <li>Reinstall your operating system</li>
                        </ul>
                        <strong style="display: block; margin-top: 0.5rem;">üì• Backup your database regularly to prevent data loss!</strong>
                    </div>
                    <div id="last-backup-info" style="margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 0.375rem; font-size: 0.875rem;"></div>
                    <div class="flex gap-2 flex-wrap">
                        <button class="btn btn-primary" onclick="exportDatabase()">üì• Download Database (.sqlite)</button>
                        <label class="btn btn-success" style="cursor: pointer;">
                            üì§ Import Database
                            <input type="file" accept=".sqlite,.db" onchange="importDatabase(event)" style="display: none;">
                        </label>
                    </div>
                    <p class="text-sm text-gray" style="margin-top: 1rem;">
                        üí° Backup your database regularly. You can open .sqlite files with DB Browser for SQLite or other database tools.
                    </p>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <h2 class="card-title">Settings</h2>
                <div class="card">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">üîß Counselor Email for Alerts</label>
                    <input type="email" id="counselor-email" class="input" placeholder="counselor@school.com" onchange="saveCounselorEmail()">
                    <p class="text-sm text-gray" style="margin-top: 0.5rem;">When a student reaches 3 or more late marks, a pre-formatted email will open in your default email application. You can review, edit, and personalize the message before sending it to this address.</p>
                    
                    <button class="btn btn-secondary" onclick="showEmailPreview()" style="margin-top: 1rem;">üëÅÔ∏è Preview Email Format</button>
                    
                    <div id="email-preview" class="hidden" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
                        <h4 style="font-weight: 600; margin-bottom: 0.5rem;">Email Preview:</h4>
                        <div class="alert alert-success" style="margin-bottom: 1rem; padding: 0.5rem;">
                            ‚ÑπÔ∏è <strong>Note:</strong> This email will open in your email application (Outlook, Gmail, Apple Mail, etc.) where you can freely edit, add comments, or modify any part of the message before sending.
                        </div>
                        <pre style="white-space: pre-wrap; font-size: 0.875rem; line-height: 1.6;">Subject: Late Attendance Alert: [Student Name] (ID: [Student ID])

Dear Counselor,

I would like to kindly inform you that the following student has been late for class on the following days:

Student Name: [Student Name]
Student ID: [Student ID]
Class: [Class Name]
Total Late Occurrences: [Number]

Late Days:
  ‚Ä¢ [Date] - Period [#]
  ‚Ä¢ [Date] - Period [#]
  ‚Ä¢ [Date] - Period [#]

Please follow up with the student regarding their punctuality.

Thank you for your attention to this matter.

Best regards,
AttendanceSystem</pre>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1rem; background: #eff6ff; border-radius: 0.375rem;">
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">CSV Import Format</h3>
                        <p class="text-sm text-gray" style="margin-bottom: 0.5rem;">Your CSV file should have this format:</p>
                        <pre style="background: white; padding: 1rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; font-size: 0.875rem;">ID,Name
12345,John Smith
12346,Jane Doe
12347,Bob Johnson</pre>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Behavior Modal -->
    <div id="behavior-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="behavior-modal-title">Record Behavior</h3>
                <button class="btn btn-secondary" onclick="closeBehaviorModal()" style="padding: 0.25rem 0.5rem;">‚úï</button>
            </div>
            <div class="modal-body">
                <label style="display: block; font-weight: 600; margin-bottom: 0.75rem;">Select Behaviors:</label>
                <div class="checkbox-grid" id="behavior-checkboxes"></div>
                
                <label style="display: block; font-weight: 600; margin: 1.5rem 0 0.5rem;">Additional Notes (Optional):</label>
                <textarea id="behavior-note" rows="4" placeholder="Add any additional details about the behavior..."></textarea>
                
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeBehaviorModal()">Cancel</button>
                    <button class="btn btn-purple" onclick="recordBehavior()">Record Behavior</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Management Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="student-modal-title">Manage Students</h3>
                <button class="btn btn-secondary" onclick="closeStudentModal()" style="padding: 0.25rem 0.5rem;">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Add Single Student -->
                <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">‚ûï Add Single Student</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Student ID:</label>
                            <input type="text" id="single-student-id" class="input" placeholder="e.g., 12345">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Student Name:</label>
                            <input type="text" id="single-student-name" class="input" placeholder="e.g., John Smith">
                        </div>
                        <button class="btn btn-success" onclick="addSingleStudent()">Add Student</button>
                    </div>
                </div>

                <!-- CSV Import -->
                <div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">üìÑ Import from CSV File</h4>
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                        <p class="text-sm" style="margin-bottom: 0.5rem;"><strong>CSV Format:</strong></p>
                        <pre style="background: white; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; font-size: 0.75rem;">ID,Name
12345,John Smith
12346,Jane Doe
12347,Bob Johnson</pre>
                    </div>
                    <label class="btn btn-primary" style="cursor: pointer; width: 100%; justify-content: center;">
                        üìÅ Choose CSV File
                        <input type="file" id="csv-file-input" accept=".csv" onchange="handleCSVFile(event)" style="display: none;">
                    </label>
                    <div id="csv-preview" style="margin-top: 1rem; display: none;">
                        <p class="text-sm text-gray" style="margin-bottom: 0.5rem;">Preview:</p>
                        <div id="csv-preview-content" style="background: #f9fafb; padding: 1rem; border-radius: 0.375rem; max-height: 200px; overflow-y: auto; font-size: 0.875rem;"></div>
                        <button class="btn btn-success" onclick="importCSVData()" style="margin-top: 1rem; width: 100%;">Import Students</button>
                    </div>
                </div>

                <!-- Current Students List -->
                <div>
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">üë• Current Students</h4>
                    <div id="student-list-modal" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Counselor Modal -->
    <div id="email-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="email-modal-title">Send Email to Counselor</h3>
                <button class="btn btn-secondary" onclick="closeEmailModal()" style="padding: 0.25rem 0.5rem;">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success" style="margin-bottom: 1rem;">
                    ‚ÑπÔ∏è <strong>Review and edit</strong> the email below before sending. You can modify any part of the message.
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">To:</label>
                    <input type="email" id="email-to" class="input" placeholder="counselor@school.com">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Subject:</label>
                    <input type="text" id="email-subject" class="input">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Message:</label>
                    <textarea id="email-body" rows="15" style="font-family: monospace; font-size: 0.875rem;"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="sendEmail()" style="background: #0ea5e9;">‚úâÔ∏è Send Email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- General Email Modal -->
    <div id="general-email-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="general-email-modal-title">Send Email About Students</h3>
                <button class="btn btn-secondary" onclick="closeGeneralEmailModal()" style="padding: 0.25rem 0.5rem;">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Student Selection -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 0.375rem;">
                    <h4 style="font-weight: 600; margin-bottom: 1rem;">Select Students:</h4>
                    <input type="text" id="student-search-email" class="input" placeholder="Search students by name or ID..." 
                           onkeyup="filterStudentsForEmail()" style="margin-bottom: 1rem;">
                    <div id="student-selection-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.5rem;">
                        <!-- Students will be loaded here -->
                    </div>
                    <p class="text-sm text-gray" style="margin-top: 0.5rem;">
                        Selected: <span id="selected-count">0</span> student(s)
                    </p>
                </div>
                
                <!-- Email Form -->
                <div class="alert alert-success" style="margin-bottom: 1rem;">
                    ‚ÑπÔ∏è <strong>Tip:</strong> Select students, then review and edit the email before sending.
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">To:</label>
                    <input type="email" id="general-email-to" class="input" placeholder="recipient@email.com">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Subject:</label>
                    <input type="text" id="general-email-subject" class="input" placeholder="Student Report">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Message:</label>
                    <textarea id="general-email-body" rows="15" style="font-family: monospace; font-size: 0.875rem;"></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="generateGeneralEmailContent()" style="background: #6b7280;">
                        üîÑ Generate Report
                    </button>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-secondary" onclick="closeGeneralEmailModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="sendGeneralEmail()" style="background: #0ea5e9;">‚úâÔ∏è Send Email</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let db = null;
        let SQL = null; // Store SQL.js constructor
        let currentView = 'dashboard';
        let selectedClass = null;
        let selectedStudent = null;
        let attendanceMarked = {};
        let currentSessionAttendance = {};
        let unsavedChanges = false;
        let viewingHistory = false;

        const behaviors = [
            'Using mobile phone',
            'Eating in class',
            'Talking/disrupting',
            'Playing games',
            'Not paying attention',
            'Late to class',
            'No homework',
            'Sleeping',
            'Fighting/arguing',
            'Disrespecting teacher'
        ];

        // Initialize SQL.js
        console.log('Loading SQL.js library from CDN...');
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(function(SQLConstructor){
            console.log('SQL.js library loaded successfully');
            SQL = SQLConstructor; // Store globally for imports
            initDatabase(SQL);
        }).catch(function(error){
            console.error('Failed to load SQL.js library:', error);
            document.getElementById('loading').innerHTML = `
                <h2 style="color: #ef4444;">Failed to Load Database Library</h2>
                <p style="margin: 1rem 0;">Could not load SQL.js from CDN.</p>
                <p style="margin: 1rem 0;">Please check your internet connection and try again.</p>
                <button onclick="location.reload();" 
                        style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
                    Retry
                </button>
                <p style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;">Error: ${error.message}</p>
            `;
        });

        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            
            // Format date: Monday, November 25, 2024
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = now.toLocaleDateString('en-US', dateOptions);
            
            // Format time: 10:30:45 AM
            const timeStr = now.toLocaleTimeString('en-US', { hour12: true });
            
            // Update the display
            const datetimeElement = document.getElementById('current-datetime');
            if (datetimeElement) {
                datetimeElement.innerHTML = `üìÖ ${dateStr}<br>üïê ${timeStr}`;
            }
        }

        // Start the clock
        setInterval(updateDateTime, 1000);
        // Initial update
        updateDateTime();

        function initDatabase(SQL) {
            console.log('Starting database initialization...');
            try {
                // Check if database exists in localStorage
                const savedDb = localStorage.getItem('attendanceDb');
                
                if (savedDb) {
                    console.log('Loading existing database from localStorage...');
                    // Load existing database
                    const uint8Array = new Uint8Array(JSON.parse(savedDb));
                    db = new SQL.Database(uint8Array);
                    console.log('Existing database loaded successfully');
                } else {
                    console.log('Creating new database...');
                    // Create new database
                    db = new SQL.Database();
                    
                    // Create tables
                    db.run(`
                        CREATE TABLE classes (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            name TEXT NOT NULL,
                            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                        )
                    `);
                    
                    db.run(`
                        CREATE TABLE students (
                            id TEXT PRIMARY KEY,
                            name TEXT NOT NULL,
                            class_id INTEGER NOT NULL,
                            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                            FOREIGN KEY (class_id) REFERENCES classes(id)
                        )
                    `);
                    
                    db.run(`
                        CREATE TABLE attendance (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            student_id TEXT NOT NULL,
                            class_id INTEGER NOT NULL,
                            date TEXT NOT NULL,
                            period INTEGER NOT NULL,
                            status TEXT NOT NULL,
                            recorded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                            late_timestamp TEXT,
                            FOREIGN KEY (student_id) REFERENCES students(id),
                            FOREIGN KEY (class_id) REFERENCES classes(id)
                        )
                    `);
                    
                    db.run(`
                        CREATE TABLE behavior (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            student_id TEXT NOT NULL,
                            class_id INTEGER NOT NULL,
                            date TEXT NOT NULL,
                            behaviors TEXT NOT NULL,
                            note TEXT,
                            recorded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                            FOREIGN KEY (student_id) REFERENCES students(id),
                            FOREIGN KEY (class_id) REFERENCES classes(id)
                        )
                    `);
                    
                    db.run(`
                        CREATE TABLE settings (
                            key TEXT PRIMARY KEY,
                            value TEXT
                        )
                    `);
                    console.log('New database created successfully');
                }
                
                // Migration: Add late_timestamp column if it doesn't exist (for existing databases)
                try {
                    // Check if column exists by trying to select it
                    db.exec('SELECT late_timestamp FROM attendance LIMIT 1');
                    console.log('late_timestamp column already exists');
                } catch (error) {
                    // Column doesn't exist, add it
                    console.log('Adding late_timestamp column to existing database...');
                    try {
                        db.run('ALTER TABLE attendance ADD COLUMN late_timestamp TEXT');
                        console.log('Migration successful: late_timestamp column added');
                    } catch (alterError) {
                        console.error('Migration error:', alterError);
                    }
                }
                
                // Save database to localStorage
                console.log('Saving database to localStorage...');
                saveDatabase();
                console.log('Database saved');
                
                // Load initial data
                console.log('Loading classes...');
                loadClasses();
                console.log('Loading settings...');
                loadSettings();
                
                // Hide loading, show app
                console.log('Showing app interface...');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                console.log('App loaded successfully!');
                
                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('attendance-date').value = today;
                document.getElementById('history-date').value = today;
                
                // Check if backup reminder is needed
                setTimeout(() => {
                    checkBackupReminder();
                }, 1000);
                
            } catch (error) {
                console.error('Database initialization error:', error);
                document.getElementById('loading').innerHTML = `
                    <h2 style="color: #ef4444;">Error Loading Database</h2>
                    <p>${error.message}</p>
                    <button onclick="localStorage.clear(); location.reload();" 
                            style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
                        Clear Data & Restart
                    </button>
                `;
            }
        }

        function saveDatabase() {
            try {
                const data = db.export();
                const buffer = Array.from(data);
                localStorage.setItem('attendanceDb', JSON.stringify(buffer));
            } catch (error) {
                console.error('Error saving database:', error);
            }
        }

        // View Management
        function showView(view) {
            // Update nav buttons
            document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                btn.classList.remove('btn-active');
            });
            
            // Only try to highlight button if called from a click event
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('btn-active');
            } else {
                // Manually find and activate the correct button
                const buttons = document.querySelectorAll('.nav-buttons .btn');
                buttons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(view)) {
                        btn.classList.add('btn-active');
                    }
                });
            }
            
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(v => {
                v.classList.add('hidden');
            });
            
            // Show selected view
            document.getElementById(view + '-view').classList.remove('hidden');
            currentView = view;
            
            // Load data for specific views
            if (view === 'export') {
                loadExportOptions();
            }
        }

        function backToDashboard() {
            if (unsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to go back?')) {
                    return;
                }
            }
            showView('dashboard');
            selectedClass = null;
            unsavedChanges = false;
            viewingHistory = false;
            loadClasses();
        }

        // Classes Management
        function loadClasses() {
            console.log('loadClasses() called');
            try {
                const grid = document.getElementById('classes-grid');
                console.log('Got classes-grid element:', grid ? 'found' : 'NOT FOUND');
                
                if (!grid) {
                    console.error('classes-grid element not found!');
                    return;
                }
                
                grid.innerHTML = '';
                
                console.log('Querying classes from database...');
                const result = db.exec('SELECT * FROM classes ORDER BY created_at DESC');
                console.log('Query result:', result);
                
                if (result.length === 0 || result[0].values.length === 0) {
                    console.log('No classes found, showing empty state');
                    grid.innerHTML = '<div class="empty-state">No classes yet. Click "Add Class" to get started.</div>';
                    return;
                }
                
                const classes = result[0].values;
                console.log(`Found ${classes.length} classes`);
                
                classes.forEach(cls => {
                    const [id, name, created_at] = cls;
                    
                    // Count students
                    const studentCount = db.exec(`SELECT COUNT(*) FROM students WHERE class_id = ${id}`);
                    const count = studentCount[0]?.values[0][0] || 0;
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3 style="font-weight: 600; margin-bottom: 0.5rem;">${name}</h3>
                        <p class="text-sm text-gray" style="margin-bottom: 1rem;">${count} students</p>
                        <div class="flex gap-2 flex-wrap">
                            <button class="btn btn-primary" onclick="openClass(${id}, '${name}')">Take Attendance</button>
                            <button class="btn btn-success" onclick="showImportStudents(${id})">Manage Students</button>
                            <button class="btn btn-primary" onclick="openGeneralEmailModal(${id}, '${name}')" style="background: #0ea5e9;">‚úâÔ∏è Send Email</button>
                            <button class="btn btn-danger" onclick="deleteClass(${id})">Delete</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                console.log('loadClasses() completed successfully');
            } catch (error) {
                console.error('Error in loadClasses():', error);
                console.error('Error stack:', error.stack);
            }
        }

        function showAddClass() {
            document.getElementById('add-class-form').classList.remove('hidden');
            document.getElementById('new-class-name').focus();
        }

        function hideAddClass() {
            document.getElementById('add-class-form').classList.add('hidden');
            document.getElementById('new-class-name').value = '';
        }

        function addClass() {
            const name = document.getElementById('new-class-name').value.trim();
            if (!name) {
                alert('Please enter a class name');
                return;
            }
            
            try {
                db.run('INSERT INTO classes (name) VALUES (?)', [name]);
                saveDatabase();
                loadClasses();
                hideAddClass();
            } catch (error) {
                alert('Error creating class: ' + error.message);
            }
        }

        function deleteClass(classId) {
            if (!confirm('Are you sure you want to delete this class? This will delete all students, attendance, and behavior records.')) {
                return;
            }
            
            try {
                db.run('DELETE FROM behavior WHERE class_id = ?', [classId]);
                db.run('DELETE FROM attendance WHERE class_id = ?', [classId]);
                db.run('DELETE FROM students WHERE class_id = ?', [classId]);
                db.run('DELETE FROM classes WHERE id = ?', [classId]);
                saveDatabase();
                loadClasses();
            } catch (error) {
                alert('Error deleting class: ' + error.message);
            }
        }

        function showImportStudents(classId) {
            selectedClass = { id: classId };
            document.getElementById('student-modal-title').textContent = 'Manage Students';
            document.getElementById('single-student-id').value = '';
            document.getElementById('single-student-name').value = '';
            document.getElementById('csv-file-input').value = '';
            document.getElementById('csv-preview').style.display = 'none';
            
            loadStudentListInModal();
            document.getElementById('student-modal').classList.add('show');
        }

        function closeStudentModal() {
            document.getElementById('student-modal').classList.remove('show');
            selectedClass = null;
            csvData = null;
            loadClasses();
        }

        function loadStudentListInModal() {
            const list = document.getElementById('student-list-modal');
            list.innerHTML = '';
            
            const result = db.exec(`SELECT id, name FROM students WHERE class_id = ${selectedClass.id} ORDER BY name`);
            
            if (result.length === 0 || result[0].values.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding: 2rem;">No students yet. Add students above.</div>';
                return;
            }
            
            result[0].values.forEach(([id, name]) => {
                const row = document.createElement('div');
                row.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb;';
                row.innerHTML = `
                    <div>
                        <strong>${name}</strong>
                        <span class="text-sm text-gray" style="margin-left: 0.5rem;">ID: ${id}</span>
                    </div>
                    <button class="btn btn-danger" onclick="deleteStudent('${id}')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Delete</button>
                `;
                list.appendChild(row);
            });
        }

        function addSingleStudent() {
            const id = document.getElementById('single-student-id').value.trim();
            const name = document.getElementById('single-student-name').value.trim();
            
            if (!id || !name) {
                alert('Please enter both Student ID and Name');
                return;
            }
            
            try {
                db.run('INSERT OR REPLACE INTO students (id, name, class_id) VALUES (?, ?, ?)', 
                    [id, name, selectedClass.id]);
                saveDatabase();
                
                document.getElementById('single-student-id').value = '';
                document.getElementById('single-student-name').value = '';
                
                loadStudentListInModal();
                
                // Show success message
                const msg = document.createElement('div');
                msg.className = 'alert alert-success';
                msg.textContent = '‚úì Student added successfully!';
                msg.style.cssText = 'margin-bottom: 1rem;';
                document.querySelector('#student-modal .modal-body').prepend(msg);
                setTimeout(() => msg.remove(), 2000);
            } catch (error) {
                alert('Error adding student: ' + error.message);
            }
        }

        function deleteStudent(studentId) {
            if (!confirm('Delete this student? This will also delete all their attendance and behavior records.')) {
                return;
            }
            
            try {
                db.run('DELETE FROM behavior WHERE student_id = ?', [studentId]);
                db.run('DELETE FROM attendance WHERE student_id = ?', [studentId]);
                db.run('DELETE FROM students WHERE id = ?', [studentId]);
                saveDatabase();
                loadStudentListInModal();
            } catch (error) {
                alert('Error deleting student: ' + error.message);
            }
        }

        let csvData = null;
        let selectedStudentsForEmail = [];

        function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.trim().split('\n');
                
                csvData = [];
                const preview = [];
                const errors = [];
                
                lines.forEach((line, index) => {
                    // Skip header row if it exists
                    if (index === 0 && line.toLowerCase().includes('id') && line.toLowerCase().includes('name')) {
                        return;
                    }
                    
                    // Skip empty lines
                    if (!line.trim()) return;
                    
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 2 && parts[0] && parts[1]) {
                        let id = parts[0];
                        const name = parts.slice(1).join(',').trim();
                        
                        // Clean the ID: remove quotes, extra characters
                        id = id.replace(/['"]/g, '').trim();
                        
                        // Validate ID: should be alphanumeric (letters and numbers only)
                        if (!/^[a-zA-Z0-9]+$/.test(id)) {
                            errors.push(`Row ${index + 1}: Invalid ID "${parts[0]}" - must contain only letters and numbers`);
                            return;
                        }
                        
                        // Validate name: not empty
                        if (!name || name.length < 2) {
                            errors.push(`Row ${index + 1}: Invalid name for ID "${id}"`);
                            return;
                        }
                        
                        csvData.push({ id, name });
                        preview.push(`${id} - ${name}`);
                    } else {
                        if (line.trim()) {
                            errors.push(`Row ${index + 1}: Invalid format - "${line.substring(0, 50)}..."`);
                        }
                    }
                });
                
                if (csvData.length === 0) {
                    let errorMsg = 'No valid data found in CSV file.';
                    if (errors.length > 0) {
                        errorMsg += '\n\nErrors found:\n' + errors.slice(0, 5).join('\n');
                        if (errors.length > 5) {
                            errorMsg += `\n... and ${errors.length - 5} more errors`;
                        }
                    }
                    alert(errorMsg);
                    return;
                }
                
                // Show preview
                let previewHTML = preview.join('<br>');
                if (errors.length > 0) {
                    previewHTML += '<div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 0.375rem;">';
                    previewHTML += '<strong>‚ö†Ô∏è Some rows were skipped due to errors:</strong><br>';
                    previewHTML += errors.slice(0, 3).join('<br>');
                    if (errors.length > 3) {
                        previewHTML += `<br>... and ${errors.length - 3} more`;
                    }
                    previewHTML += '</div>';
                }
                
                document.getElementById('csv-preview-content').innerHTML = previewHTML;
                document.getElementById('csv-preview').style.display = 'block';
            };
            reader.readAsText(file);
        }

        function importCSVData() {
            if (!csvData || csvData.length === 0) {
                alert('No data to import');
                return;
            }
            
            let imported = 0;
            let errors = 0;
            
            csvData.forEach(({ id, name }) => {
                try {
                    db.run('INSERT OR REPLACE INTO students (id, name, class_id) VALUES (?, ?, ?)', 
                        [id, name, selectedClass.id]);
                    imported++;
                } catch (error) {
                    console.error('Error importing student:', error);
                    errors++;
                }
            });
            
            saveDatabase();
            csvData = null;
            document.getElementById('csv-file-input').value = '';
            document.getElementById('csv-preview').style.display = 'none';
            
            loadStudentListInModal();
            
            // Show success message
            const msg = document.createElement('div');
            msg.className = 'alert alert-success';
            msg.textContent = `‚úì Imported ${imported} students${errors > 0 ? ` (${errors} errors)` : ''}`;
            msg.style.cssText = 'margin-bottom: 1rem;';
            document.querySelector('#student-modal .modal-body').prepend(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        // Attendance Management
        function openClass(classId, className) {
            selectedClass = { id: classId, name: className };
            document.getElementById('attendance-title').textContent = className;
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('attendance-view').classList.remove('hidden');
            
            viewingHistory = false;
            unsavedChanges = false;
            document.getElementById('unsaved-alert').classList.add('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            document.getElementById('attendance-actions').classList.remove('hidden');
            document.getElementById('viewing-history-alert').classList.add('hidden');
            document.getElementById('history-button-view').classList.remove('hidden');
            document.getElementById('history-form-view').classList.add('hidden');
            
            loadStudentsForAttendance();
        }

        function loadStudentsForAttendance() {
            const list = document.getElementById('students-list');
            list.innerHTML = '';
            
            const result = db.exec(`SELECT id, name FROM students WHERE class_id = ${selectedClass.id} ORDER BY name`);
            
            if (result.length === 0 || result[0].values.length === 0) {
                list.innerHTML = '<div class="empty-state">No students in this class. Add students from the dashboard.</div>';
                return;
            }
            
            const students = result[0].values;
            const date = document.getElementById('attendance-date').value;
            const period = document.getElementById('attendance-period').value;
            
            // Load existing attendance for this date/period
            attendanceMarked = {};
            const attendanceResult = db.exec(
                `SELECT student_id, status FROM attendance 
                 WHERE class_id = ${selectedClass.id} AND date = '${date}' AND period = ${period}`
            );
            
            if (attendanceResult.length > 0) {
                attendanceResult[0].values.forEach(([studentId, status]) => {
                    attendanceMarked[studentId] = status;
                });
            }
            
            students.forEach(([id, name]) => {
                // Check currentSessionAttendance FIRST (latest changes), then attendanceMarked (saved data)
                const status = currentSessionAttendance[id] || attendanceMarked[id] || '';
                const isMarked = status !== '';
                
                // Get behavior count for today
                const behaviorCount = db.exec(
                    `SELECT COUNT(*) FROM behavior 
                     WHERE student_id = '${id}' AND date = '${date}'`
                );
                const todayBehaviors = behaviorCount[0]?.values[0][0] || 0;
                
                // Get late count
                const lateCount = db.exec(
                    `SELECT COUNT(*) FROM attendance 
                     WHERE student_id = '${id}' AND status = 'Late'`
                );
                const totalLates = lateCount[0]?.values[0][0] || 0;
                
                const row = document.createElement('div');
                row.className = 'student-row' + (isMarked ? ' marked' : '');
                row.innerHTML = `
                    <div>
                        <strong>${name}</strong>
                        <span class="text-sm text-gray" style="margin-left: 0.5rem;">ID: ${id}</span>
                        ${todayBehaviors > 0 ? `<span class="badge badge-purple" style="margin-left: 0.5rem;">${todayBehaviors} behavior(s) today</span>` : ''}
                        ${totalLates >= 3 ? `<span class="badge badge-red" style="margin-left: 0.5rem;">‚ö†Ô∏è ${totalLates} lates</span>` : ''}
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        ${!viewingHistory ? `
                            <button class="btn ${status === 'Present' ? 'btn-success' : 'btn-secondary'}" 
                                onclick="markAttendance('${id}', 'Present')">
                                ${status === 'Present' ? '‚úì ' : ''}Present
                            </button>
                            <button class="btn ${status === 'Late' ? 'btn-warning' : 'btn-secondary'}" 
                                onclick="markAttendance('${id}', 'Late')">
                                ${status === 'Late' ? '‚úì ' : ''}Late
                            </button>
                            <button class="btn ${status === 'Absent' ? 'btn-danger' : 'btn-secondary'}" 
                                onclick="markAttendance('${id}', 'Absent')">
                                ${status === 'Absent' ? '‚úì ' : ''}Absent
                            </button>
                            <button class="btn btn-purple" onclick="openBehaviorModal('${id}', '${name}')">
                                ‚ö†Ô∏è Behavior
                            </button>
                        ` : `
                            <span class="badge ${
                                status === 'Present' ? 'badge-green' : 
                                status === 'Late' ? 'badge-orange' : 
                                status === 'Absent' ? 'badge-red' : 'badge-gray'
                            }">${status || 'Not Recorded'}</span>
                        `}
                    </div>
                `;
                list.appendChild(row);
            });
        }

        function markAttendance(studentId, status) {
            if (viewingHistory) return;
            
            currentSessionAttendance[studentId] = status;
            attendanceMarked[studentId] = status; // Also update this for immediate display
            unsavedChanges = true;
            document.getElementById('unsaved-alert').classList.remove('hidden');
            document.getElementById('save-btn').classList.remove('hidden');
            
            loadStudentsForAttendance();
        }

        function markAllPresent() {
            if (viewingHistory) return;
            
            const result = db.exec(`SELECT id FROM students WHERE class_id = ${selectedClass.id}`);
            if (result.length > 0) {
                result[0].values.forEach(([id]) => {
                    currentSessionAttendance[id] = 'Present';
                    attendanceMarked[id] = 'Present'; // Also update this for immediate display
                });
                unsavedChanges = true;
                document.getElementById('unsaved-alert').classList.remove('hidden');
                document.getElementById('save-btn').classList.remove('hidden');
                loadStudentsForAttendance();
            }
        }

        function saveAttendance() {
            const date = document.getElementById('attendance-date').value;
            const period = document.getElementById('attendance-period').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            try {
                // Merge attendanceMarked and currentSessionAttendance
                // currentSessionAttendance has priority (newer changes)
                const allAttendance = { ...attendanceMarked, ...currentSessionAttendance };
                
                // Delete existing attendance for this date/period
                db.run(
                    `DELETE FROM attendance WHERE class_id = ? AND date = ? AND period = ?`,
                    [selectedClass.id, date, period]
                );
                
                // Insert new attendance records and track late students
                const lateStudentsToday = [];
                for (const [studentId, status] of Object.entries(allAttendance)) {
                    // Record timestamp for late students
                    const lateTimestamp = status === 'Late' ? new Date().toISOString() : null;
                    
                    db.run(
                        `INSERT INTO attendance (student_id, class_id, date, period, status, late_timestamp) 
                         VALUES (?, ?, ?, ?, ?, ?)`,
                        [studentId, selectedClass.id, date, period, status, lateTimestamp]
                    );
                    
                    // Track if student was marked late today
                    if (status === 'Late') {
                        lateStudentsToday.push(studentId);
                    }
                }
                
                saveDatabase();
                
                unsavedChanges = false;
                currentSessionAttendance = {};
                document.getElementById('unsaved-alert').classList.add('hidden');
                document.getElementById('save-btn').classList.add('hidden');
                
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.textContent = '‚úì Attendance saved successfully!';
                document.querySelector('#attendance-view .card').prepend(alert);
                setTimeout(() => alert.remove(), 3000);
                
                loadStudentsForAttendance();
            } catch (error) {
                alert('Error saving attendance: ' + error.message);
            }
        }

        function openEmailModalFromSearch(studentId, studentName, classId, className) {
            // Set the selected class context temporarily for the email
            selectedClass = { id: classId, name: className };
            openEmailModal(studentId, studentName);
        }

        function openEmailModal(studentId, studentName) {
            selectedStudent = { id: studentId, name: studentName };
            
            // Get counselor email
            const emailResult = db.exec("SELECT value FROM settings WHERE key = 'counselor_email'");
            const counselorEmail = emailResult.length > 0 && emailResult[0].values[0][0] 
                ? emailResult[0].values[0][0] 
                : 'counselor@school.com';
            
            // Get ALL late records with timestamps
            const lateRecords = db.exec(
                `SELECT date, period, late_timestamp FROM attendance 
                 WHERE student_id = '${studentId}' AND status = 'Late'
                 ORDER BY date DESC, period DESC`
            );
            
            let lateList = '';
            let totalLates = 0;
            if (lateRecords.length > 0 && lateRecords[0].values.length > 0) {
                totalLates = lateRecords[0].values.length;
                lateRecords[0].values.forEach(([date, period, timestamp]) => {
                    const timeStr = timestamp ? new Date(timestamp).toLocaleString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    }) : 'N/A';
                    lateList += `  ‚Ä¢ ${date} - Period ${period} (Recorded at: ${timeStr})\n`;
                });
            }
            
            // Get ALL absent records
            const absentRecords = db.exec(
                `SELECT date, period FROM attendance 
                 WHERE student_id = '${studentId}' AND status = 'Absent'
                 ORDER BY date DESC, period DESC`
            );
            
            let absentList = '';
            let totalAbsences = 0;
            if (absentRecords.length > 0 && absentRecords[0].values.length > 0) {
                totalAbsences = absentRecords[0].values.length;
                absentRecords[0].values.forEach(([date, period]) => {
                    absentList += `  ‚Ä¢ ${date} - Period ${period}\n`;
                });
            }
            
            // Get ALL behavior records
            const behaviorRecords = db.exec(
                `SELECT date, behaviors, note FROM behavior 
                 WHERE student_id = '${studentId}'
                 ORDER BY date DESC`
            );
            
            let behaviorList = '';
            let totalBehaviors = 0;
            if (behaviorRecords.length > 0 && behaviorRecords[0].values.length > 0) {
                totalBehaviors = behaviorRecords[0].values.length;
                behaviorRecords[0].values.forEach(([date, behaviors, note]) => {
                    behaviorList += `  ‚Ä¢ ${date}: ${behaviors}\n`;
                    if (note) {
                        behaviorList += `    Note: ${note}\n`;
                    }
                });
            }
            
            // Build comprehensive email
            const subject = `Student Concern: ${studentName} (ID: ${studentId})`;
            
            let body = `Dear Counselor,

I would like to bring to your attention some concerns regarding the following student:

Student Name: ${studentName}
Student ID: ${studentId}
Class: ${selectedClass.name}

ATTENDANCE SUMMARY:
`;
            
            if (totalLates > 0) {
                body += `\nLate Arrivals (${totalLates} total):\n${lateList}`;
            }
            
            if (totalAbsences > 0) {
                body += `\nAbsences (${totalAbsences} total):\n${absentList}`;
            }
            
            if (totalBehaviors > 0) {
                body += `\nBEHAVIOR INCIDENTS (${totalBehaviors} total):\n${behaviorList}`;
            }
            
            body += `
Please follow up with the student regarding these concerns.

Thank you for your attention to this matter.

Best regards,
Attendance System`;
            
            // Populate modal
            document.getElementById('email-modal-title').textContent = `Send Email - ${studentName}`;
            document.getElementById('email-to').value = counselorEmail;
            document.getElementById('email-subject').value = subject;
            document.getElementById('email-body').value = body;
            
            // Show modal
            document.getElementById('email-modal').classList.add('show');
        }

        function closeEmailModal() {
            document.getElementById('email-modal').classList.remove('show');
            selectedStudent = null;
        }

        function sendEmail() {
            const to = document.getElementById('email-to').value.trim();
            const subject = document.getElementById('email-subject').value.trim();
            const body = document.getElementById('email-body').value.trim();
            
            if (!to) {
                alert('Please enter a recipient email address');
                return;
            }
            
            if (!subject || !body) {
                alert('Please enter a subject and message');
                return;
            }
            
            // Create mailto link
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            // Close modal
            closeEmailModal();
            
            // Show confirmation
            setTimeout(() => {
                alert('‚úâÔ∏è Email opened in your email client.\n\nPlease review and send when ready.');
            }, 500);
        }

        // General Email Modal Functions
        function openGeneralEmailModal(classId, className) {
            selectedClass = { id: classId, name: className };
            selectedStudentsForEmail = [];
            
            document.getElementById('general-email-modal-title').textContent = `Send Email - ${className}`;
            document.getElementById('general-email-to').value = '';
            document.getElementById('general-email-subject').value = `Report - ${className}`;
            document.getElementById('general-email-body').value = '';
            document.getElementById('student-search-email').value = '';
            
            // Load all students in the class
            loadStudentsForEmailSelection();
            
            document.getElementById('general-email-modal').classList.add('show');
        }

        function closeGeneralEmailModal() {
            document.getElementById('general-email-modal').classList.remove('show');
            selectedStudentsForEmail = [];
            selectedClass = null;
        }

        function loadStudentsForEmailSelection() {
            const container = document.getElementById('student-selection-list');
            container.innerHTML = '';
            
            const result = db.exec(`SELECT id, name FROM students WHERE class_id = ${selectedClass.id} ORDER BY name`);
            
            if (result.length === 0 || result[0].values.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 1rem; color: #9ca3af;">No students in this class</p>';
                return;
            }
            
            result[0].values.forEach(([id, name]) => {
                const div = document.createElement('div');
                div.className = 'student-email-item';
                div.style.cssText = 'padding: 0.5rem; border-bottom: 1px solid #e5e7eb; cursor: pointer;';
                div.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" value="${id}" onchange="toggleStudentSelection('${id}', '${name}')" 
                               style="margin-right: 0.75rem; width: 1.25rem; height: 1.25rem;">
                        <div>
                            <strong>${name}</strong>
                            <span style="color: #6b7280; font-size: 0.875rem; margin-left: 0.5rem;">ID: ${id}</span>
                        </div>
                    </label>
                `;
                container.appendChild(div);
            });
            
            updateSelectedCount();
        }

        function filterStudentsForEmail() {
            const searchTerm = document.getElementById('student-search-email').value.toLowerCase();
            const items = document.querySelectorAll('.student-email-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function toggleStudentSelection(studentId, studentName) {
            const index = selectedStudentsForEmail.findIndex(s => s.id === studentId);
            
            if (index > -1) {
                // Remove from selection
                selectedStudentsForEmail.splice(index, 1);
            } else {
                // Add to selection
                selectedStudentsForEmail.push({ id: studentId, name: studentName });
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedStudentsForEmail.length;
        }

        function generateGeneralEmailContent() {
            if (selectedStudentsForEmail.length === 0) {
                alert('Please select at least one student');
                return;
            }
            
            let body = `Dear Recipient,

Please find below the attendance and behavior report for selected students from ${selectedClass.name}:

`;
            
            selectedStudentsForEmail.forEach(student => {
                // Get attendance stats
                const stats = db.exec(
                    `SELECT status, COUNT(*) as count 
                     FROM attendance 
                     WHERE student_id = '${student.id}' 
                     GROUP BY status`
                );
                
                let present = 0, late = 0, absent = 0;
                if (stats.length > 0) {
                    stats[0].values.forEach(([status, count]) => {
                        if (status === 'Present') present = count;
                        if (status === 'Late') late = count;
                        if (status === 'Absent') absent = count;
                    });
                }
                
                // Get recent lates with timestamps
                const lates = db.exec(
                    `SELECT date, period, late_timestamp FROM attendance 
                     WHERE student_id = '${student.id}' AND status = 'Late'
                     ORDER BY date DESC LIMIT 5`
                );
                
                // Get absences
                const absences = db.exec(
                    `SELECT date, period FROM attendance 
                     WHERE student_id = '${student.id}' AND status = 'Absent'
                     ORDER BY date DESC LIMIT 5`
                );
                
                // Get behaviors
                const behaviors = db.exec(
                    `SELECT date, behaviors, note FROM behavior 
                     WHERE student_id = '${student.id}'
                     ORDER BY date DESC LIMIT 3`
                );
                
                body += `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
STUDENT: ${student.name} (ID: ${student.id})
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Attendance Summary:
  Present: ${present} | Late: ${late} | Absent: ${absent}
`;
                
                if (lates.length > 0 && lates[0].values.length > 0) {
                    body += '\nRecent Late Arrivals:\n';
                    lates[0].values.forEach(([date, period, timestamp]) => {
                        const timeStr = timestamp ? new Date(timestamp).toLocaleString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        }) : 'N/A';
                        body += `  ‚Ä¢ ${date} - Period ${period} (at ${timeStr})\n`;
                    });
                }
                
                if (absences.length > 0 && absences[0].values.length > 0) {
                    body += '\nRecent Absences:\n';
                    absences[0].values.forEach(([date, period]) => {
                        body += `  ‚Ä¢ ${date} - Period ${period}\n`;
                    });
                }
                
                if (behaviors.length > 0 && behaviors[0].values.length > 0) {
                    body += '\nBehavior Incidents:\n';
                    behaviors[0].values.forEach(([date, behaviorList, note]) => {
                        body += `  ‚Ä¢ ${date}: ${behaviorList}\n`;
                        if (note) body += `    Note: ${note}\n`;
                    });
                }
                
                body += '\n';
            });
            
            body += `
Please let me know if you need any additional information.

Best regards,
${selectedClass.name} Teacher`;
            
            document.getElementById('general-email-body').value = body;
        }

        function sendGeneralEmail() {
            const to = document.getElementById('general-email-to').value.trim();
            const subject = document.getElementById('general-email-subject').value.trim();
            const body = document.getElementById('general-email-body').value.trim();
            
            if (!to) {
                alert('Please enter a recipient email address');
                return;
            }
            
            if (!subject || !body) {
                alert('Please enter a subject and message');
                return;
            }
            
            // Create mailto link
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            // Close modal
            closeGeneralEmailModal();
            
            // Show confirmation
            setTimeout(() => {
                alert('‚úâÔ∏è Email opened in your email client.\n\nPlease review and send when ready.');
            }, 500);
        }

        function onDateOrPeriodChange() {
            if (unsavedChanges) {
                if (!confirm('You have unsaved changes. Changing the date/period will discard them. Continue?')) {
                    return;
                }
            }
            currentSessionAttendance = {};
            unsavedChanges = false;
            viewingHistory = false;
            document.getElementById('unsaved-alert').classList.add('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            document.getElementById('attendance-actions').classList.remove('hidden');
            document.getElementById('viewing-history-alert').classList.add('hidden');
            document.getElementById('history-button-view').classList.remove('hidden');
            document.getElementById('history-form-view').classList.add('hidden');
            loadStudentsForAttendance();
        }

        function viewHistory() {
            const date = document.getElementById('history-date').value;
            const period = document.getElementById('history-period').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            // Set the main date/period controls
            document.getElementById('attendance-date').value = date;
            document.getElementById('attendance-period').value = period;
            
            viewingHistory = true;
            unsavedChanges = false;
            currentSessionAttendance = {};
            document.getElementById('unsaved-alert').classList.add('hidden');
            document.getElementById('save-btn').classList.add('hidden');
            document.getElementById('attendance-actions').classList.add('hidden');
            document.getElementById('viewing-history-alert').classList.remove('hidden');
            
            // Hide the history form
            document.getElementById('history-form-view').classList.add('hidden');
            document.getElementById('history-button-view').classList.add('hidden');
            
            loadStudentsForAttendance();
        }

        function showHistoryControls() {
            document.getElementById('history-button-view').classList.add('hidden');
            document.getElementById('history-form-view').classList.remove('hidden');
            
            // Set history date to today by default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('history-date').value = today;
        }

        function hideHistoryControls() {
            document.getElementById('history-form-view').classList.add('hidden');
            document.getElementById('history-button-view').classList.remove('hidden');
        }

        function exitHistoryMode() {
            viewingHistory = false;
            document.getElementById('viewing-history-alert').classList.add('hidden');
            document.getElementById('attendance-actions').classList.remove('hidden');
            document.getElementById('history-button-view').classList.remove('hidden');
            document.getElementById('history-form-view').classList.add('hidden');
            
            // Reset to today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            
            loadStudentsForAttendance();
        }

        // Behavior Management
        function openBehaviorModal(studentId, studentName) {
            selectedStudent = { id: studentId, name: studentName };
            document.getElementById('behavior-modal-title').textContent = `Record Behavior - ${studentName}`;
            
            const container = document.getElementById('behavior-checkboxes');
            container.innerHTML = '';
            
            behaviors.forEach(behavior => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" value="${behavior}">
                    <span>${behavior}</span>
                `;
                container.appendChild(label);
            });
            
            document.getElementById('behavior-note').value = '';
            document.getElementById('behavior-modal').classList.add('show');
        }

        function closeBehaviorModal() {
            document.getElementById('behavior-modal').classList.remove('show');
            selectedStudent = null;
        }

        function recordBehavior() {
            const checkboxes = document.querySelectorAll('#behavior-checkboxes input[type="checkbox"]:checked');
            const selectedBehaviors = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedBehaviors.length === 0) {
                alert('Please select at least one behavior');
                return;
            }
            
            const note = document.getElementById('behavior-note').value.trim();
            const date = document.getElementById('attendance-date').value;
            
            try {
                db.run(
                    `INSERT INTO behavior (student_id, class_id, date, behaviors, note) 
                     VALUES (?, ?, ?, ?, ?)`,
                    [selectedStudent.id, selectedClass.id, date, selectedBehaviors.join(', '), note]
                );
                
                saveDatabase();
                closeBehaviorModal();
                
                // Show success message
                alert('Behavior recorded successfully');
                
                // Reload student list to update behavior counts
                loadStudentsForAttendance();
            } catch (error) {
                alert('Error recording behavior: ' + error.message);
            }
        }

        // Search Functionality
        function searchStudents() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                alert('Please enter a student ID or name');
                return;
            }
            
            const results = document.getElementById('search-results');
            results.innerHTML = '';
            
            // Search students
            const studentResult = db.exec(
                `SELECT s.id, s.name, c.name as class_name 
                 FROM students s 
                 JOIN classes c ON s.class_id = c.id 
                 WHERE s.id LIKE '%${query}%' OR s.name LIKE '%${query}%'`
            );
            
            if (studentResult.length === 0 || studentResult[0].values.length === 0) {
                results.innerHTML = '<div class="card"><div class="empty-state">No students found</div></div>';
                return;
            }
            
            studentResult[0].values.forEach(([id, name, className]) => {
                // Get class_id for email modal
                const classIdResult = db.exec(
                    `SELECT class_id FROM students WHERE id = '${id}'`
                );
                const classId = classIdResult[0]?.values[0][0];
                
                // Get attendance summary
                const attendanceStats = db.exec(
                    `SELECT status, COUNT(*) as count 
                     FROM attendance 
                     WHERE student_id = '${id}' 
                     GROUP BY status`
                );
                
                let stats = { Present: 0, Late: 0, Absent: 0 };
                if (attendanceStats.length > 0) {
                    attendanceStats[0].values.forEach(([status, count]) => {
                        stats[status] = count;
                    });
                }
                
                // Get behavior count AND count unique days with behavior
                const behaviorDaysCount = db.exec(
                    `SELECT COUNT(DISTINCT date) FROM behavior WHERE student_id = '${id}'`
                );
                const behaviorDays = behaviorDaysCount[0]?.values[0][0] || 0;
                
                const totalBehaviorsCount = db.exec(
                    `SELECT COUNT(*) FROM behavior WHERE student_id = '${id}'`
                );
                const totalBehaviors = totalBehaviorsCount[0]?.values[0][0] || 0;
                
                // Get recent behaviors
                const recentBehaviors = db.exec(
                    `SELECT date, behaviors, note 
                     FROM behavior 
                     WHERE student_id = '${id}' 
                     ORDER BY date DESC 
                     LIMIT 5`
                );
                
                // Get recent attendance
                const recentAttendance = db.exec(
                    `SELECT date, period, status, late_timestamp 
                     FROM attendance 
                     WHERE student_id = '${id}' 
                     ORDER BY date DESC, period DESC 
                     LIMIT 10`
                );
                
                const card = document.createElement('div');
                card.className = 'card';
                
                // Email button appears ONLY if: 3+ lates AND behavior on 3+ different days
                const needsAttention = stats.Late >= 3 && behaviorDays >= 3;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <h3 style="font-weight: 600; margin-bottom: 0.25rem;">${name}</h3>
                            <p class="text-sm text-gray">ID: ${id} | Class: ${className}</p>
                        </div>
                        ${needsAttention ? `
                            <button class="btn btn-primary" onclick="openEmailModalFromSearch('${id}', '${name}', ${classId}, '${className}')" style="background: #0ea5e9;">
                                ‚úâÔ∏è Send Email to Counselor
                            </button>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <h4 style="font-weight: 600; margin-bottom: 0.5rem;">üìä Attendance Summary</h4>
                        <div class="flex gap-2 flex-wrap">
                            <span class="badge badge-green">Present: ${stats.Present}</span>
                            <span class="badge badge-orange">Late: ${stats.Late}</span>
                            <span class="badge badge-red">Absent: ${stats.Absent}</span>
                            <span class="badge badge-purple">Behaviors: ${totalBehaviors}</span>
                        </div>
                    </div>
                    
                    ${recentAttendance.length > 0 && recentAttendance[0].values.length > 0 ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">üìÖ Recent Attendance</h4>
                            <div style="font-size: 0.875rem;">
                                ${recentAttendance[0].values.map(([date, period, status, lateTimestamp]) => {
                                    let displayText = `${date} - Period ${period}: <strong>${status}</strong>`;
                                    if (status === 'Late' && lateTimestamp) {
                                        const timeStr = new Date(lateTimestamp).toLocaleString('en-US', {
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            hour12: true
                                        });
                                        displayText += ` <span style="color: #6b7280;">(at ${timeStr})</span>`;
                                    }
                                    return `<div style="padding: 0.25rem 0;">${displayText}</div>`;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${recentBehaviors.length > 0 && recentBehaviors[0].values.length > 0 ? `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è Recent Behaviors</h4>
                            <div style="font-size: 0.875rem;">
                                ${recentBehaviors[0].values.map(([date, behaviors, note]) => 
                                    `<div style="padding: 0.5rem 0; border-bottom: 1px solid #f3f4f6;">
                                        <div><strong>${date}</strong></div>
                                        <div>${behaviors}</div>
                                        ${note ? `<div class="text-gray">${note}</div>` : ''}
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
                results.appendChild(card);
            });
        }

        // Export Functionality
        function loadExportOptions() {
            const classSelect = document.getElementById('export-class');
            const behaviorClassSelect = document.getElementById('export-behavior-class');
            
            [classSelect, behaviorClassSelect].forEach(select => {
                select.innerHTML = '<option value="">All Classes</option>';
                
                const result = db.exec('SELECT id, name FROM classes ORDER BY name');
                if (result.length > 0) {
                    result[0].values.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                }
            });
            
            // Set default date range to current month
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('export-from-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('export-to-date').value = today.toISOString().split('T')[0];
            
            // Update backup info
            updateLastBackupInfo();
        }

        function exportAttendance() {
            const classId = document.getElementById('export-class').value;
            const fromDate = document.getElementById('export-from-date').value;
            const toDate = document.getElementById('export-to-date').value;
            
            if (!fromDate || !toDate) {
                alert('Please select date range');
                return;
            }
            
            let query = `
                SELECT 
                    s.id as student_id,
                    s.name as student_name,
                    c.name as class_name,
                    a.date,
                    a.period,
                    a.status
                FROM attendance a
                JOIN students s ON a.student_id = s.id
                JOIN classes c ON a.class_id = c.id
                WHERE a.date BETWEEN '${fromDate}' AND '${toDate}'
            `;
            
            if (classId) {
                query += ` AND a.class_id = ${classId}`;
            }
            
            query += ' ORDER BY a.date DESC, s.name, a.period';
            
            const result = db.exec(query);
            
            if (result.length === 0 || result[0].values.length === 0) {
                alert('No attendance records found for the selected criteria');
                return;
            }
            
            // Create Excel workbook
            const data = [
                ['Student ID', 'Student Name', 'Class', 'Date', 'Period', 'Status'],
                ...result[0].values
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance Report');
            
            const filename = `attendance_report_${fromDate}_to_${toDate}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function exportBehavior() {
            const classId = document.getElementById('export-behavior-class').value;
            
            let query = `
                SELECT 
                    s.id as student_id,
                    s.name as student_name,
                    c.name as class_name,
                    b.date,
                    b.behaviors,
                    b.note
                FROM behavior b
                JOIN students s ON b.student_id = s.id
                JOIN classes c ON b.class_id = c.id
            `;
            
            if (classId) {
                query += ` WHERE b.class_id = ${classId}`;
            }
            
            query += ' ORDER BY b.date DESC, s.name';
            
            const result = db.exec(query);
            
            if (result.length === 0 || result[0].values.length === 0) {
                alert('No behavior records found');
                return;
            }
            
            // Create Excel workbook
            const data = [
                ['Student ID', 'Student Name', 'Class', 'Date', 'Behaviors', 'Notes'],
                ...result[0].values
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Behavior Report');
            
            const filename = `behavior_report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function exportDatabase() {
            try {
                const data = db.export();
                const blob = new Blob([data], { type: 'application/x-sqlite3' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_backup_${new Date().toISOString().split('T')[0]}.sqlite`;
                a.click();
                URL.revokeObjectURL(url);
                
                // Record backup time
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                updateLastBackupInfo();
                
                // Show success message
                setTimeout(() => {
                    alert('‚úÖ Database backed up successfully!\n\nKeep this file in a safe location (e.g., Google Drive, OneDrive, USB drive).');
                }, 100);
            } catch (error) {
                alert('Error exporting database: ' + error.message);
            }
        }

        function updateLastBackupInfo() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            const infoDiv = document.getElementById('last-backup-info');
            
            if (!infoDiv) return;
            
            if (!lastBackup) {
                infoDiv.innerHTML = '‚ö†Ô∏è <strong>No backup found!</strong> You have never backed up your database. Please create a backup now.';
                infoDiv.style.background = '#fef2f2';
                infoDiv.style.border = '1px solid #fca5a5';
                return;
            }
            
            const backupDate = new Date(lastBackup);
            const now = new Date();
            const daysSinceBackup = Math.floor((now - backupDate) / (1000 * 60 * 60 * 24));
            
            const dateStr = backupDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            if (daysSinceBackup === 0) {
                infoDiv.innerHTML = `‚úÖ <strong>Last backup:</strong> Today at ${backupDate.toLocaleTimeString('en-US')}`;
                infoDiv.style.background = '#d1fae5';
                infoDiv.style.border = '1px solid #10b981';
            } else if (daysSinceBackup <= 7) {
                infoDiv.innerHTML = `‚úì <strong>Last backup:</strong> ${dateStr} (${daysSinceBackup} day${daysSinceBackup > 1 ? 's' : ''} ago)`;
                infoDiv.style.background = '#fef3c7';
                infoDiv.style.border = '1px solid #fbbf24';
            } else {
                infoDiv.innerHTML = `‚ö†Ô∏è <strong>Last backup:</strong> ${dateStr} (${daysSinceBackup} days ago)<br><strong>Warning:</strong> It's been over a week! Please backup your database.`;
                infoDiv.style.background = '#fef2f2';
                infoDiv.style.border = '1px solid #fca5a5';
            }
        }

        function checkBackupReminder() {
            const lastBackup = localStorage.getItem('lastBackupDate');
            
            if (!lastBackup) {
                // First time user - show warning after they create some data
                const hasClasses = db.exec('SELECT COUNT(*) FROM classes');
                if (hasClasses[0]?.values[0][0] > 0) {
                    setTimeout(() => {
                        if (confirm('‚ö†Ô∏è BACKUP REMINDER\n\nYou have not backed up your database yet.\n\nYour data is only stored in this browser and can be lost if you clear your browser data or switch devices.\n\nWould you like to go to the Export page to create a backup?')) {
                            showView('export');
                            loadExportOptions();
                        }
                    }, 2000);
                }
                return;
            }
            
            const backupDate = new Date(lastBackup);
            const now = new Date();
            const daysSinceBackup = Math.floor((now - backupDate) / (1000 * 60 * 60 * 24));
            
            // Remind every 14 days
            if (daysSinceBackup >= 14) {
                const lastReminder = localStorage.getItem('lastBackupReminder');
                const reminderDate = lastReminder ? new Date(lastReminder) : new Date(0);
                const daysSinceReminder = Math.floor((now - reminderDate) / (1000 * 60 * 60 * 24));
                
                // Only remind once per day
                if (daysSinceReminder >= 1) {
                    setTimeout(() => {
                        if (confirm(`‚ö†Ô∏è BACKUP REMINDER\n\nIt has been ${daysSinceBackup} days since your last backup.\n\nYour data could be at risk!\n\nWould you like to backup now?`)) {
                            showView('export');
                            loadExportOptions();
                        }
                        localStorage.setItem('lastBackupReminder', now.toISOString());
                    }, 3000);
                }
            }
        }

        function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('Importing a database will replace all current data. Are you sure?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const uint8Array = new Uint8Array(e.target.result);
                    db = new SQL.Database(uint8Array); // Use the stored SQL constructor
                    saveDatabase();
                    alert('Database imported successfully!');
                    loadClasses();
                    showView('dashboard');
                } catch (error) {
                   // alert('Error importing database: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // Settings
        function loadSettings() {
            console.log('loadSettings() called');
            try {
                const emailInput = document.getElementById('counselor-email');
                console.log('Got counselor-email element:', emailInput ? 'found' : 'NOT FOUND');
                
                if (!emailInput) {
                    console.error('counselor-email element not found!');
                    return;
                }
                
                console.log('Querying settings from database...');
                const result = db.exec("SELECT value FROM settings WHERE key = 'counselor_email'");
                console.log('Settings query result:', result);
                
                if (result.length > 0 && result[0].values.length > 0) {
                    emailInput.value = result[0].values[0][0];
                    console.log('Loaded counselor email');
                }
                console.log('loadSettings() completed successfully');
            } catch (error) {
                console.error('Error in loadSettings():', error);
                console.error('Error stack:', error.stack);
            }
        }

        function saveCounselorEmail() {
            const email = document.getElementById('counselor-email').value.trim();
            try {
                db.run("INSERT OR REPLACE INTO settings (key, value) VALUES ('counselor_email', ?)", [email]);
                saveDatabase();
            } catch (error) {
                alert('Error saving email: ' + error.message);
            }
        }

        function showEmailPreview() {
            const preview = document.getElementById('email-preview');
            if (preview.classList.contains('hidden')) {
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
